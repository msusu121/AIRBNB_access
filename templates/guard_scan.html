{% extends "base.html" %}
{% block title %}Guard Scanner{% endblock %}
{% block content %}
<div class="grid md:grid-cols-2 gap-4">
  <div class="bg-white rounded-2xl shadow-sm p-6">
    <div class="flex items-center justify-between">
      <h1 class="text-xl font-semibold">Guard Scanner</h1>

      <!-- Mode toggle -->
      <div class="inline-flex rounded-xl border border-slate-300 overflow-hidden">
        <button id="btnScan"   type="button" class="px-3 py-1.5 text-sm bg-slate-900 text-white">Scan</button>
        <button id="btnManual" type="button" class="px-3 py-1.5 text-sm hover:bg-slate-50">Manual</button>
      </div>
    </div>

    <form id="scanForm" class="space-y-3 mt-3">
      <label class="text-sm">Checkpoint</label>
      <select name="checkpoint_id" class="w-full rounded-xl border border-slate-300 px-3 py-2" required>
        {% for c in checkpoints %}
          <option value="{{ c.id }}">{{ c.property.name }} – {{ c.name }}</option>
        {% endfor %}
      </select>

      <!-- Manual ID (hidden in Scan mode) -->
      <div id="manualWrap" class="hidden">
        <label class="text-sm">Manual National ID</label>
        <input id="manualId" type="text" inputmode="numeric" pattern="\d*" maxlength="16"
               class="w-full rounded-xl border border-slate-300 px-3 py-2"
               placeholder="Type 8-digit ID">
        <p class="text-xs text-slate-500 mt-1">We’ll use this ID directly.</p>
      </div>

      <!-- Live camera (shown in Scan mode) -->
      <div id="cameraWrap">
        <label class="text-sm">Live camera (rear)</label>
        <div id="videoWrap" class="aspect-video bg-slate-100 rounded-2xl overflow-hidden ring-1 ring-slate-200 transition relative">
          <!-- High band overlay (top 18%, height 20%) -->
          <div class="absolute inset-x-0 pointer-events-none" style="top:18%; height:20%;">
            <div class="w-full h-full ring-2 ring-amber-400/60 rounded"></div>
          </div>
          <video id="video" autoplay playsinline muted class="w-full h-full object-cover"></video>
        </div>
        <canvas id="canvas" class="hidden"></canvas>
        <p class="text-xs text-slate-500 mt-1">Place the ID number within the yellow band, then press “Check Access”.</p>
      </div>

      <!-- hidden (last detected) -->
      <input type="hidden" id="detected_id" name="detected_id" value="">

      <button id="submitBtn" type="submit" class="w-full rounded-xl bg-slate-900 text-white py-2 hover:bg-slate-800">
        Check Access
      </button>
    </form>
  </div>

  <!-- Result -->
  <div id="result" class="bg-white rounded-2xl shadow-sm p-6">
    <p class="text-sm text-slate-500">Scan result will appear here.</p>
  </div>
</div>

<!-- Toasts -->
<div id="toast" class="fixed top-4 right-4 z-50 space-y-2"></div>

<!-- Tesseract.js -->
<script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
<script>
(async function(){
  const video       = document.getElementById('video');
  const videoWrap   = document.getElementById('videoWrap');
  const canvas      = document.getElementById('canvas');
  const form        = document.getElementById('scanForm');
  const result      = document.getElementById('result');
  const toastBox    = document.getElementById('toast');
  const hiddenDet   = document.getElementById('detected_id');
  const manualId    = document.getElementById('manualId');
  const submitBtn   = document.getElementById('submitBtn');

  const btnScan     = document.getElementById('btnScan');
  const btnManual   = document.getElementById('btnManual');
  const cameraWrap  = document.getElementById('cameraWrap');
  const manualWrap  = document.getElementById('manualWrap');

  let mode = 'scan'; // 'scan' | 'manual'
  function setMode(newMode){
    mode = newMode;
    if (mode === 'scan'){
      btnScan.classList.add('bg-slate-900','text-white');
      btnManual.classList.remove('bg-slate-900','text-white');
      cameraWrap.classList.remove('hidden');
      manualWrap.classList.add('hidden');
      startRear();
    } else {
      btnManual.classList.add('bg-slate-900','text-white');
      btnScan.classList.remove('bg-slate-900','text-white');
      manualWrap.classList.remove('hidden');
      cameraWrap.classList.add('hidden');
      stopRear();
    }
  }
  btnScan.addEventListener('click', ()=>setMode('scan'));
  btnManual.addEventListener('click', ()=>setMode('manual'));
  setMode('scan');

  // ---------- helpers ----------
  function toast(msg, ok=true, ms=1600) {
    const el = document.createElement('div');
    el.className = `px-3 py-2 rounded-xl shadow text-sm ${ok?'bg-slate-900 text-white':'bg-red-600 text-white'}`;
    el.textContent = msg;
    toastBox.appendChild(el);
    setTimeout(()=>{ el.classList.add('opacity-0','transition','duration-500'); }, ms-500);
    setTimeout(()=>{ el.remove(); }, ms);
  }
  const chip = (t)=>`<span class="inline-flex items-center rounded-full border px-2 py-0.5 text-xs font-medium border-slate-300 text-slate-700 bg-white">${t}</span>`;
  const fmtDT = (iso)=>{ try { return new Date(iso).toLocaleString(); } catch { return iso || '-'; } };
  function glow(state) {
    videoWrap.classList.remove('ring-emerald-400','ring-rose-400','animate-pulse','ring-2');
    if (state==='ok'){ videoWrap.classList.add('ring-2','ring-emerald-400'); setTimeout(()=>glow('clear'),900); }
    if (state==='fail'){ videoWrap.classList.add('ring-2','ring-rose-400','animate-pulse'); setTimeout(()=>glow('clear'),1200); }
  }

  // ---------- camera ----------
  let stream = null;
  async function startRear() {
    if (stream || mode !== 'scan') return;
    const tries = [
      { video: { facingMode: { exact: "environment" }, width: { ideal: 1920 }, height: { ideal: 1080 } } },
      { video: { facingMode: "environment", width: { ideal: 1920 }, height: { ideal: 1080 } } },
      { video: { width: { ideal: 1280 }, height: { ideal: 720 } } }
    ];
    for (const c of tries) {
      try {
        stream = await navigator.mediaDevices.getUserMedia(c);
        video.srcObject = stream;
        await new Promise(r => video.onloadedmetadata = r);
        toast('Camera ready ✅');
        return;
      } catch(e) {}
    }
    toast('Rear camera not available', false);
  }
  function stopRear(){
    if (stream){
      for (const t of stream.getTracks()) t.stop();
      stream = null;
      video.srcObject = null;
    }
  }
  await startRear();

  // ---------- OCR init ----------
  const worker = await Tesseract.createWorker();
  await worker.loadLanguage('eng');
  await worker.initialize('eng');
  await worker.setParameters({ tessedit_char_whitelist:'0123456789', user_defined_dpi:'300' });

  // normalize just for OCR glitches (O→0, I→1, etc.)
  const normDigits = (s)=>s
    .replace(/[OoD]/g,'0')
    .replace(/[Il|!]/g,'1')
    .replace(/[Ss]/g,'5')
    .replace(/[Zz]/g,'2')
    .replace(/[qg]/g,'9');

  function grabTopBandCanvas() {
    const W = video.videoWidth, H = video.videoHeight;
    if (!W || !H) return null;
    // must match overlay: top 18%, height 20%
    const top   = Math.floor(H * 0.18);
    const bandH = Math.floor(H * 0.20);
    canvas.width = W; canvas.height = bandH;
    const ctx = canvas.getContext('2d');
    ctx.drawImage(video, 0, top, W, bandH, 0, 0, W, bandH);
    return canvas;
  }

  // Build a set of 8-digit strings that come from dotted/slashed dates in the raw OCR
  function dateDigitSetFromRaw(raw){
    const out = new Set();
    // matches like 08.06.1999, 08/06/1999, 08-06-1999
    const matches = raw.match(/\b(\d{2})[.\-\/](\d{2})[.\-\/](\d{4})\b/g) || [];
    for (const d of matches){
      const digits = d.replace(/\D+/g,''); // 08.06.1999 -> 08061999
      if (digits.length === 8) out.add(digits);
    }
    return out;
  }

  async function ocrBand(cnv) {
    const { data } = await worker.recognize(cnv);
    const rawText      = data.text || '';
    const normalized   = normDigits(rawText);
    const digitsOnly   = normalized.replace(/\D+/g,'');     // keep only digits for candidate scan
    const candidates   = digitsOnly.match(/\d{8}/g) || [];  // all 8-digit runs

    // exclude any 8-digit value that came from a dotted/slashed date in the raw OCR
    const dateDigits = dateDigitSetFromRaw(rawText);
    const id = candidates.find(d => !dateDigits.has(d)) || '';

    // quick average confidence
    let avgConf = 0;
    if (Array.isArray(data.words) && data.words.length) {
      const confs = data.words.map(w => w.confidence || 0);
      avgConf = Math.round(confs.reduce((a,b)=>a+b,0)/confs.length);
    }
    return { id, conf: avgConf };
  }

  // One-shot detection when pressing "Check Access" (Scan mode)
  async function detectOnce() {
    const cnv = grabTopBandCanvas();
    if (!cnv) return { id:'', conf:0 };
    const r = await ocrBand(cnv);
    if (r.id && r.conf >= 50) return r;
    return { id:'', conf:r.conf||0 };
  }

  async function sendOnce() {
    submitBtn.disabled = true;
    try {
      const fd = new FormData();
      fd.append('checkpoint_id', form.querySelector('select[name="checkpoint_id"]').value);

      let idToUse = '';
      if (mode === 'manual') {
        idToUse = (manualId.value || '').trim();
      } else {
        toast('Scanning…');
        const r = await detectOnce();
        if (r.id) {
          idToUse = r.id;
          hiddenDet.value = r.id;
        }
      }

      if (!idToUse) {
        toast('No ID detected — keep the number inside the band or switch to Manual.', false);
        glow('fail');
        return;
      }

      fd.append('detected_id', idToUse);

      const resp = await fetch('/guard/scan', { method: 'POST', body: fd });
      const json = await resp.json();

      renderResult(json, idToUse);
      glow(json.decision === 'allow' ? 'ok' : 'clear');
      toast(json.decision === 'allow' ? 'ACCESS ALLOWED' : 'ACCESS DENIED', json.decision === 'allow');
    } catch (e) {
      console.error(e);
      toast('Network error', false);
    } finally {
      submitBtn.disabled = false;
    }
  }

  function renderResult(json, idNum) {
    const allowed = json.decision === 'allow';
    const toneBox = allowed ? 'bg-emerald-50 text-emerald-800 border-emerald-200'
                            : 'bg-rose-50 text-rose-800 border-rose-200';
    const toneDot = allowed ? 'bg-emerald-500' : 'bg-rose-500';
    const toneLabel = allowed ? 'ALLOWED' : 'DENIED';
    const idChip = idNum ? chip(`ID: ${idNum}`) : '';

    if (json.info) {
      const i = json.info;
      const vehicle = i.owns_vehicle ? `
        <div class="flex items-center gap-2">
          <span class="inline-flex h-2 w-2 rounded-full bg-slate-400"></span>
          <span class="text-slate-600">Vehicle</span>
          ${chip(i.vehicle_plate || '—')}
        </div>` : '';

      result.innerHTML = `
        <div class="rounded-2xl border border-slate-200 bg-white overflow-hidden">
          <div class="px-4 py-3 border-b ${allowed ? 'border-emerald-100' : 'border-rose-100'} ${toneBox}">
            <div class="flex items-center justify-between">
              <div class="flex items-center gap-2">
                <span class="h-2.5 w-2.5 rounded-full ${toneDot}"></span>
                <span class="text-sm font-semibold tracking-wide">${toneLabel}</span>
              </div>
              <div class="flex items-center gap-2">${idChip}</div>
            </div>
          </div>

          <div class="p-4">
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
              <div class="space-y-1">
                <div class="text-xs uppercase tracking-wider text-slate-500">Guest</div>
                <div class="text-sm font-medium text-slate-900">${i.guest_name}</div>
                <div class="text-xs text-slate-500">National ID</div>
                <div class="text-sm text-slate-700">${i.national_id}</div>
              </div>

              <div class="space-y-1">
                <div class="text-xs uppercase tracking-wider text-slate-500">Property & Room</div>
                <div class="text-sm font-medium text-slate-900">${i.property}</div>
                <div class="text-sm text-slate-700">${chip(i.room)}</div>
              </div>

              <div class="space-y-1">
                <div class="text-xs uppercase tracking-wider text-slate-500">Stay Window</div>
                <div class="text-sm text-slate-900">${fmtDT(i.check_in)}</div>
                <div class="text-sm text-slate-700">→ ${fmtDT(i.check_out)}</div>
              </div>

              <div class="space-y-1">
                <div class="text-xs uppercase tracking-wider text-slate-500">Party</div>
                <div class="flex items-center gap-2">
                  ${chip(`${i.guests_count} ${i.guests_count === 1 ? 'guest' : 'guests'}`)}
                  ${vehicle}
                </div>
              </div>
            </div>
          </div>

          <div class="px-4 py-3 bg-slate-50 border-t border-slate-200">
            <div class="text-xs text-slate-500">
              Booking #${i.booking_id} • Verified now
            </div>
          </div>
        </div>
      `;
      return;
    }

    const noId = json.reason === 'ocr_no_id_detected' || (!idNum && !json.info);
    if (noId) glow('fail');

    result.innerHTML = `
      <div class="rounded-2xl border border-slate-200 bg-white overflow-hidden">
        <div class="px-4 py-3 border-b ${allowed ? 'border-emerald-100' : 'border-rose-100'} ${toneBox}">
          <div class="flex items-center gap-2">
            <span class="h-2.5 w-2.5 rounded-full ${toneDot}"></span>
            <span class="text-sm font-semibold">${toneLabel}</span>
            ${idChip}
          </div>
        </div>
        <div class="p-4 space-y-3">
          <p class="text-sm text-slate-700">
            ${noId ? 'No ID detected. Type it (Manual mode) or press Check Access again in Scan mode.' : (json.message || 'No active booking found.')}
          </p>
          ${json.debug?.extracted_national_id ? `<p class="mt-2 text-xs text-slate-500">Detected: ${json.debug.extracted_national_id || '—'}</p>` : ''}
        </div>
      </div>
    `;
  }

  // Submit
  form.addEventListener('submit', async (e) => {
    e.preventDefault();
    await sendOnce();
  });

  // Enter key on manual field
  manualId?.addEventListener('keydown', (e) => {
    if (e.key === 'Enter') {
      e.preventDefault();
      form.requestSubmit();
    }
  });
})();
</script>
{% endblock %}
