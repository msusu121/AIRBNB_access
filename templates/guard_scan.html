{% extends "base.html" %}
{% block content %}
<div class="grid md:grid-cols-2 gap-4">
  <div class="bg-white rounded-2xl shadow-sm p-6">
    <h1 class="text-xl font-semibold">Guard Scanner</h1>

    <form id="scanForm" class="space-y-3" enctype="multipart/form-data">
      <label class="text-sm">Checkpoint</label>
      <select name="checkpoint_id" class="w-full rounded-xl border border-slate-300 px-3 py-2" required>
        {% for c in checkpoints %}
          <option value="{{ c.id }}">{{ c.property.name }} – {{ c.name }}</option>
        {% endfor %}
      </select>

      <!-- Manual ID -->
      <div>
        <label class="text-sm">Manual National ID (optional)</label>
        <input id="manualId" type="text" inputmode="numeric" pattern="\d*" maxlength="16"
               class="w-full rounded-xl border border-slate-300 px-3 py-2"
               placeholder="Type ID and press Check Access">
        <p class="text-xs text-slate-500 mt-1">If filled, we’ll use this ID directly (no photo needed).</p>
      </div>

      <!-- Upload / Take Photo -->
      <div>
        <label class="text-sm">Upload / Take Photo (rear)</label>
        <input type="file" name="image" accept="image/*" capture="environment"
               class="w-full rounded-xl border border-slate-300 px-3 py-2">
      </div>

      <!-- Live camera -->
      <div>
        <label class="text-sm">Live camera (rear)</label>
        <div id="videoWrap" class="aspect-video bg-slate-100 rounded-2xl overflow-hidden ring-1 ring-slate-200 transition">
          <video id="video" autoplay playsinline muted class="w-full h-full object-cover"></video>
        </div>
        <div class="mt-2 flex gap-2">
          <button id="snap" type="button" class="px-3 py-2 rounded-xl border bg-white hover:bg-slate-50">Capture</button>
          <canvas id="canvas" class="hidden"></canvas>
        </div>
      </div>

      <!-- hidden field for OCR-detected id -->
      <input type="hidden" id="detected_id" name="detected_id" value="">

      <button id="submitBtn" type="submit" class="w-full rounded-xl bg-slate-900 text-white py-2 hover:bg-slate-800">
        Check Access
      </button>
    </form>
  </div>

  <!-- Result -->
  <div id="result" class="bg-white rounded-2xl shadow-sm p-6">
    <p class="text-sm text-slate-500">Scan result will appear here.</p>
  </div>
</div>

<!-- Toasts -->
<div id="toast" class="fixed top-4 right-4 z-50 space-y-2"></div>

<!-- Tesseract.js -->
<script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
<script>
(async function(){
  const video       = document.getElementById('video');
  const videoWrap   = document.getElementById('videoWrap');
  const canvas      = document.getElementById('canvas');
  const snap        = document.getElementById('snap');
  const form        = document.getElementById('scanForm');
  const result      = document.getElementById('result');
  const toastBox    = document.getElementById('toast');
  const hiddenDet   = document.getElementById('detected_id');
  const manualId    = document.getElementById('manualId');
  const submitBtn   = document.getElementById('submitBtn');

  function toast(msg, ok=true, ms=1600) {
    const el = document.createElement('div');
    el.className = `px-3 py-2 rounded-xl shadow text-sm ${ok?'bg-slate-900 text-white':'bg-red-600 text-white'}`;
    el.textContent = msg;
    toastBox.appendChild(el);
    setTimeout(()=>{ el.classList.add('opacity-0','transition','duration-500'); }, ms-500);
    setTimeout(()=>{ el.remove(); }, ms);
  }
  const chip = (t)=>`<span class="inline-flex items-center rounded-full border px-2 py-0.5 text-xs font-medium border-slate-300 text-slate-700 bg-white">${t}</span>`;
  const fmtDT = (iso)=>{ try { return new Date(iso).toLocaleString(); } catch { return iso || '-'; } };
  function glow(state) {
    videoWrap.classList.remove('ring-emerald-400','ring-rose-400','animate-pulse','ring-2');
    if (state==='ok'){ videoWrap.classList.add('ring-2','ring-emerald-400'); setTimeout(()=>glow('clear'),900); }
    if (state==='fail'){ videoWrap.classList.add('ring-2','ring-rose-400','animate-pulse'); setTimeout(()=>glow('clear'),1200); }
  }

  // Camera
  async function startRear() {
    const tries = [
      { video: { facingMode: { exact: "environment" }, width: { ideal: 1920 }, height: { ideal: 1080 } } },
      { video: { facingMode: "environment", width: { ideal: 1920 }, height: { ideal: 1080 } } },
      { video: { width: { ideal: 1280 }, height: { ideal: 720 } } }
    ];
    for (const c of tries) {
      try {
        const stream = await navigator.mediaDevices.getUserMedia(c);
        video.srcObject = stream;
        await new Promise(r => video.onloadedmetadata = r);
        toast('Camera ready ✅');
        return;
      } catch(e) {}
    }
    toast('Rear camera not available', false);
  }
  await startRear();

  // Capture helper
  snap?.addEventListener('click', async () => {
    const blob = await captureFrameBlob();
    if (!blob) return;
    const dt = new DataTransfer();
    dt.items.add(new File([blob], 'capture.jpg', { type: 'image/jpeg' }));
    const input = form.querySelector('input[name="image"]');
    input.files = dt.files;
    toast('Frame captured');
  });
  async function captureFrameBlob() {
    const w = video.videoWidth, h = video.videoHeight;
    if (!w || !h) { toast('Camera not ready', false); return null; }
    canvas.width = w; canvas.height = h;
    canvas.getContext('2d').drawImage(video, 0, 0, w, h);
    return await new Promise(r => canvas.toBlob(r, 'image/jpeg', 0.9));
  }

  // OCR worker (auto)
  const worker = await Tesseract.createWorker();
  await worker.loadLanguage('eng');
  await worker.initialize('eng');
  await worker.setParameters({ tessedit_char_whitelist:'0123456789', user_defined_dpi:'300' });
  const normDigits = (s)=>s.replace(/[OoD]/g,'0').replace(/[Il|!]/g,'1').replace(/[Ss]/g,'5').replace(/[Zz]/g,'2').replace(/[qg]/g,'9');

  let sending=false, lastSent='';

  async function autoScan() {
    const w = video.videoWidth, h = video.videoHeight;
    if (!w || !h || sending) return;

    // if guard typed something, don't override
    if (manualId.value.trim()) return;

    canvas.width = w; canvas.height = h;
    const ctx = canvas.getContext('2d');
    ctx.drawImage(video, 0, 0, w, h);
    const bandH = Math.floor(h * 0.28);
    const top = Math.floor((h - bandH) / 2);
    const band = document.createElement('canvas');
    band.width = w; band.height = bandH;
    band.getContext('2d').drawImage(canvas, 0, top, w, bandH, 0, 0, w, bandH);

    const { data } = await worker.recognize(band);
    const text = normDigits(data.text || '');
    const m = text.match(/\b\d{8}\b/);
    if (!m) return;

    const idNum = m[0];
    if (idNum === lastSent) return;

    // simple confidence gate
    let avgConf = 70;
    if (Array.isArray(data.words) && data.words.length) {
      const confs = data.words.map(w => w.confidence || 0);
      avgConf = Math.round(confs.reduce((a,b)=>a+b,0)/confs.length);
    }
    if (avgConf < 60) return;

    hiddenDet.value = idNum;
    await sendOnce({ detectedId: idNum, attachSnapshot: true });
  }

  async function sendOnce({ detectedId = '', attachSnapshot = false } = {}) {
    if (sending) return;
    sending = true; submitBtn.disabled = true;

    try {
      const fd = new FormData();
      fd.append('checkpoint_id', form.querySelector('select[name="checkpoint_id"]').value);

      // Prefer manual text if present
      const manual = manualId.value.trim();
      if (manual) {
        fd.append('detected_id', manual);
        lastSent = manual;
      } else if (detectedId) {
        fd.append('detected_id', detectedId);
        lastSent = detectedId;
      } else if (hiddenDet.value) {
        fd.append('detected_id', hiddenDet.value);
        lastSent = hiddenDet.value;
      }

      // Only attach photo if we didn't have manual ID and we want a snapshot
      if (!manual && attachSnapshot) {
        const fileInput = form.querySelector('input[name="image"]');
        if (fileInput.files.length > 0) {
          fd.append('image', fileInput.files[0]);
        } else {
          const blob = await captureFrameBlob();
          if (blob) fd.append('image', new File([blob], 'auto.jpg', { type: 'image/jpeg' }));
        }
      }

      const resp = await fetch('/guard/scan', { method: 'POST', body: fd });
      const json = await resp.json();

      renderResult(json, lastSent);
      glow(json.decision === 'allow' ? 'ok' : 'clear');
      toast(json.decision === 'allow' ? 'ACCESS ALLOWED' : 'ACCESS DENIED', json.decision === 'allow');
    } catch (e) {
      console.error(e);
      toast('Network error', false);
    } finally {
      sending = false; submitBtn.disabled = false;
    }
  }

  function renderResult(json, idNum) {
    const allowed = json.decision === 'allow';
    const toneBox = allowed ? 'bg-emerald-50 text-emerald-800 border-emerald-200'
                            : 'bg-rose-50 text-rose-800 border-rose-200';
    const toneDot = allowed ? 'bg-emerald-500' : 'bg-rose-500';
    const toneLabel = allowed ? 'ALLOWED' : 'DENIED';
    const idChip = idNum ? chip(`ID: ${idNum}`) : '';

    if (json.info) {
      const i = json.info;
      const vehicle = i.owns_vehicle ? `
        <div class="flex items-center gap-2">
          <span class="inline-flex h-2 w-2 rounded-full bg-slate-400"></span>
          <span class="text-slate-600">Vehicle</span>
          ${chip(i.vehicle_plate || '—')}
        </div>` : '';

      result.innerHTML = `
        <div class="rounded-2xl border border-slate-200 bg-white overflow-hidden">
          <div class="px-4 py-3 border-b ${allowed ? 'border-emerald-100' : 'border-rose-100'} ${toneBox}">
            <div class="flex items-center justify-between">
              <div class="flex items-center gap-2">
                <span class="h-2.5 w-2.5 rounded-full ${toneDot}"></span>
                <span class="text-sm font-semibold tracking-wide">${toneLabel}</span>
              </div>
              <div class="flex items-center gap-2">${idChip}</div>
            </div>
          </div>

          <div class="p-4">
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
              <div class="space-y-1">
                <div class="text-xs uppercase tracking-wider text-slate-500">Guest</div>
                <div class="text-sm font-medium text-slate-900">${i.guest_name}</div>
                <div class="text-xs text-slate-500">National ID</div>
                <div class="text-sm text-slate-700">${i.national_id}</div>
              </div>

              <div class="space-y-1">
                <div class="text-xs uppercase tracking-wider text-slate-500">Property & Room</div>
                <div class="text-sm font-medium text-slate-900">${i.property}</div>
                <div class="text-sm text-slate-700">${chip(i.room)}</div>
              </div>

              <div class="space-y-1">
                <div class="text-xs uppercase tracking-wider text-slate-500">Stay Window</div>
                <div class="text-sm text-slate-900">${fmtDT(i.check_in)}</div>
                <div class="text-sm text-slate-700">→ ${fmtDT(i.check_out)}</div>
              </div>

              <div class="space-y-1">
                <div class="text-xs uppercase tracking-wider text-slate-500">Party</div>
                <div class="flex items-center gap-2">
                  ${chip(`${i.guests_count} ${i.guests_count === 1 ? 'guest' : 'guests'}`)}
                  ${vehicle}
                </div>
              </div>
            </div>
          </div>

          <div class="px-4 py-3 bg-slate-50 border-t border-slate-200">
            <div class="text-xs text-slate-500">
              Booking #${i.booking_id} • Verified now
            </div>
          </div>
        </div>
      `;
      return;
    }

    const noId = json.reason === 'ocr_no_id_detected' || (!idNum && !json.info);
    if (noId) glow('fail');

    result.innerHTML = `
      <div class="rounded-2xl border border-slate-200 bg-white overflow-hidden">
        <div class="px-4 py-3 border-b ${allowed ? 'border-emerald-100' : 'border-rose-100'} ${toneBox}">
          <div class="flex items-center gap-2">
            <span class="h-2.5 w-2.5 rounded-full ${toneDot}"></span>
            <span class="text-sm font-semibold">${toneLabel}</span>
            ${idChip}
          </div>
        </div>
        <div class="p-4 space-y-3">
          <p class="text-sm text-slate-700">
            ${noId ? 'No ID number detected. Please type the ID or rescan.' : (json.message || 'No active booking found.')}
          </p>
          ${json.debug?.extracted_national_id ? `<p class="mt-2 text-xs text-slate-500">Detected: ${json.debug.extracted_national_id || '—'}</p>` : ''}
        </div>
      </div>
    `;
  }

  // loop
  setInterval(() => autoScan().catch(()=>{}), 800);

  // submit (prefer manual if present)
  form.addEventListener('submit', async (e) => {
    e.preventDefault();
    await sendOnce({ detectedId: hiddenDet.value, attachSnapshot: !manualId.value.trim() });
  });
})();
</script>
{% endblock %}
