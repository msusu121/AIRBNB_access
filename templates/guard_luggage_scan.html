{% extends "base.html" %}
{% block title %}Luggage QR Scanner{% endblock %}
{% block content %}
<div class="grid md:grid-cols-2 gap-4">
  <!-- SCANNER -->
  <div class="bg-white rounded-2xl shadow-sm p-6 space-y-4">
    <div class="flex items-center justify-between">
      <h1 class="text-xl font-semibold">Luggage QR Scanner</h1>
    </div>

    <form id="scanForm" class="space-y-4">
      <div>
        
        <div id="videoWrap" class="aspect-video bg-slate-100 rounded-2xl overflow-hidden ring-1 ring-slate-200 relative">
          <video id="video" autoplay playsinline muted class="w-full h-full object-cover"></video>
          <div class="absolute inset-0 pointer-events-none flex items-center justify-center">
            <div class="w-2/3 h-2/3 rounded-2xl ring-2 ring-emerald-400/60"></div>
          </div>
        </div>
        
        <div id="camStatus" class="text-xs text-slate-500 mt-1">Camera: initializing…</div>
      </div>

      <input type="hidden" id="qrTokenField" name="qr_token" value="">
      <button id="submitBtn" type="submit" class="w-full rounded-xl bg-slate-900 text-white py-2 hover:bg-slate-800">
        
      </button>
    </form>
  </div>

  <!-- RESULT -->
  <div id="result" class="bg-white rounded-2xl shadow-sm p-6">
    <p class="text-sm text-slate-500">Scan result will appear here.</p>
  </div>
</div>

<!-- Toasts -->
<div id="toast" class="fixed top-4 right-4 z-50 space-y-2"></div>

<!-- qr-scanner -->
<script type="module">
import QrScanner from "https://cdn.jsdelivr.net/npm/qr-scanner@1.4.2/qr-scanner.min.js";

const form        = document.getElementById('scanForm');
const video       = document.getElementById('video');
const videoWrap   = document.getElementById('videoWrap');
const camStatus   = document.getElementById('camStatus');
const qrField     = document.getElementById('qrTokenField');
const resultBox   = document.getElementById('result');
const toastBox    = document.getElementById('toast');
const submitBtn   = document.getElementById('submitBtn');

let scanner;
let scanCooldown = false;

function toast(msg, ok=true, ms=1600){
  const el = document.createElement('div');
  el.className = `px-3 py-2 rounded-xl shadow text-sm ${ok ? 'bg-slate-900 text-white' : 'bg-rose-600 text-white'}`;
  el.textContent = msg;
  toastBox.appendChild(el);
  setTimeout(()=>{ el.classList.add('opacity-0','transition','duration-500'); }, ms-400);
  setTimeout(()=> el.remove(), ms);
}
function glow(state){
  videoWrap.classList.remove('ring-emerald-400','ring-rose-400','ring-2','animate-pulse');
  if(state==='ok'){ videoWrap.classList.add('ring-2','ring-emerald-400'); setTimeout(()=>glow(null), 900); }
  if(state==='fail'){ videoWrap.classList.add('ring-2','ring-rose-400','animate-pulse'); setTimeout(()=>glow(null), 1200); }
}

async function startScanner(){
  try{
    scanner = new QrScanner(video, onScan, {
      preferredCamera: 'environment',
      highlightScanRegion: true,
      highlightCodeOutline: true,
      maxScansPerSecond: 8,
      returnDetailedScanResult: true
    });
    await scanner.start();
    camStatus.textContent = 'Camera: Rear • scanning…';
  }catch(e){
    console.error(e);
    camStatus.textContent = 'Camera: unavailable';
    toast('Camera/QR init failed', false);
  }
}

function onScan(res){
  const token = (res?.data || '').trim();
  if(!token || scanCooldown) return;
  scanCooldown = true;
  setTimeout(()=> scanCooldown = false, 1500);

  qrField.value = token;
  glow('ok');
  toast('QR captured ✅');
  submitToServer();
}

form.addEventListener('submit', (e)=>{
  e.preventDefault();
  if(!qrField.value){ toast('No QR detected', false); glow('fail'); return; }
  submitToServer();
});

async function submitToServer(){
  submitBtn.disabled = true;
  try{
    const fd = new FormData(form); // only qr_token is sent (no checkpoint)
    const resp = await fetch('{{ url_for("luggage.guard_scan_post") }}', { method:'POST', body: fd });
    const json = await resp.json();
    renderResult(json);
    glow(json.decision === 'allow' ? 'ok' : 'fail');
    toast(json.decision === 'allow' ? 'EXIT ALLOWED' : 'DENIED', json.decision === 'allow');
    if(navigator.vibrate) navigator.vibrate(json.decision === 'allow' ? 20 : [30,40,30]);
  }catch(e){
    console.error(e);
    toast('Network error', false);
    glow('fail');
  }finally{
    submitBtn.disabled = false;
  }
}

function renderResult(json){
  const allowed = json.decision === 'allow';
  const toneBox = allowed ? 'bg-emerald-50 text-emerald-800 border-emerald-200'
                          : 'bg-rose-50 text-rose-800 border-rose-200';
  const toneDot = allowed ? 'bg-emerald-500' : 'bg-rose-500';
  const toneLabel = allowed ? 'ALLOWED' : 'DENIED';

  if(json.info){
    const i = json.info;
    resultBox.innerHTML = `
      <div class="rounded-2xl border border-slate-200 bg-white overflow-hidden">
        <div class="px-4 py-3 border-b ${allowed ? 'border-emerald-100' : 'border-rose-100'} ${toneBox}">
          <div class="flex items-center gap-2">
            <span class="h-2.5 w-2.5 rounded-full ${toneDot}"></span>
            <span class="text-sm font-semibold tracking-wide">${toneLabel}</span>
          </div>
        </div>
        <div class="p-4 space-y-3">
          <div class="grid sm:grid-cols-2 gap-4">
            <div>
              <div class="text-xs uppercase tracking-wider text-slate-500">Luggage</div>
              <div class="text-sm font-medium">#${i.luggage_id} • ${i.label}</div>
              <div class="text-xs text-slate-500 capitalize">${i.size}</div>
              <div class="mt-1 text-xs">Status: <span class="font-medium">${i.status}</span></div>
            </div>
            <div>
              <div class="text-xs uppercase tracking-wider text-slate-500">Guest / Stay</div>
              <div class="text-sm font-medium">${i.guest_name}</div>
              <div class="text-xs text-slate-500">${i.property} • ${i.room}</div>
            </div>
          </div>
          ${i.photo ? `<img src="${i.photo}" class="rounded-xl ring-1 ring-slate-200 max-h-48 object-contain bg-slate-50">` : ''}
        </div>
      </div>
    `;
    return;
  }

  resultBox.innerHTML = `
    <div class="rounded-2xl border border-slate-200 bg-white overflow-hidden">
      <div class="px-4 py-3 ${toneBox}">
        <div class="flex items-center gap-2">
          <span class="h-2.5 w-2.5 rounded-full ${toneDot}"></span>
          <span class="text-sm font-semibold">${toneLabel}</span>
        </div>
      </div>
      <div class="p-4">
        <p class="text-sm text-slate-700">${json.message || 'QR not recognized.'}</p>
      </div>
    </div>
  `;
}

// Auto-start camera
startScanner();
</script>
{% endblock %}
